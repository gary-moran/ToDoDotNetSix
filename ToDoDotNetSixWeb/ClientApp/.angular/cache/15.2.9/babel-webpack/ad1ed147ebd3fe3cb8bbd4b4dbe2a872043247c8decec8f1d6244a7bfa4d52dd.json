{"ast":null,"code":"import _asyncToGenerator from \"C:/Projects/web/ToDoDotNetSix/ToDoDotNetSixWeb/ClientApp/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { JwtHelperService } from '@auth0/angular-jwt';\nimport { BehaviorSubject, catchError, first, map, shareReplay, Subject, throwError } from 'rxjs';\nimport { Generic } from '../models/generic';\nimport { Message } from '../models/message';\nimport { MessageType } from '../models/message-type.enum';\nimport { IsTrue } from '../utilities/is-true';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"./app-config.service\";\nimport * as i2 from \"@angular/common/http\";\nimport * as i3 from \"./message.service\";\nimport * as i4 from \"@angular/router\";\nimport * as i5 from \"./view-model-data.service\";\nexport class AuthenticationService {\n  constructor(appConfigService, httpClient, messageService, router, viewModelDataService) {\n    // authenticate and store token\n    this.appConfigService = appConfigService;\n    this.httpClient = httpClient;\n    this.messageService = messageService;\n    this.router = router;\n    this.viewModelDataService = viewModelDataService;\n    this._authenticated$ = new Subject();\n    this.authenticated$ = this._authenticated$.pipe(shareReplay(1));\n    this._logout$ = new BehaviorSubject(false);\n    this.logout$ = this._logout$.asObservable();\n    this.apiBaseUrl = \"\";\n    this.token = \"\";\n    this.tokenExpiration = new Date();\n    this.userId = null;\n    this.username = null;\n    this.authenticated = false;\n    this.refreshPending = false;\n    this.jwtHelper = new JwtHelperService();\n    this.appConfigService.AppConfig.subscribe(config => {\n      if (config) {\n        this.apiBaseUrl = config?.WebApi ?? \"\";\n        const session = this.getSession();\n        if (session != null && !this.authenticated) {\n          if (!this.jwtHelper.isTokenExpired(session.token)) {\n            this.token = session.token;\n            this.tokenExpiration = this.jwtHelper.getTokenExpirationDate(session.token);\n            this.userId = session.user;\n            this.newAuthenticationEvent(true);\n          } else {\n            this.refreshToken().subscribe(() => {});\n          }\n        }\n      }\n    });\n  }\n  /**\r\n  * Check if the current session is Authenticated\r\n  */\n  checkAuthenticated() {\n    if (!this.isAuthenticated(true)) {\n      this.logout();\n      this.router.navigate([\"/login\"]);\n      this.messageService.sendMessage(new Message(\"nav-menu\", \"The current session has expired.\", MessageType.Info), true);\n      return false;\n    } else return true;\n  }\n  /**\r\n   * Returns whether the user is authenticated\r\n   */\n  isAuthenticated(recheckSession = false) {\n    if (recheckSession) {\n      // Grab the latest version of the current session before checking the Auth Status\n      const session = this.getSession();\n      if (session) {\n        this.token = session.token;\n        this.userId = session.user;\n        return IsTrue.eval(this.userId) && IsTrue.eval(this.token) && !this.jwtHelper.isTokenExpired(this.token);\n      } else {\n        // No session then log out user\n        return false;\n      }\n    } else {\n      return IsTrue.eval(this.userId) && IsTrue.eval(this.token) && !this.jwtHelper.isTokenExpired(this.token) && this.authenticated;\n    }\n  }\n  /**\r\n   * Creates a new authentication event\r\n   * @param authenticated\r\n   */\n  newAuthenticationEvent(authenticated) {\n    this.authenticated = authenticated;\n    this._authenticated$.next(authenticated);\n  }\n  /**\r\n   * Attempts to refresh the users authentication token\r\n   */\n  refreshToken() {\n    if (!this.refreshPending) {\n      this.refreshPending = true;\n      const session = this.getSession();\n      if (session) {\n        return this.httpClient.post(`${this.apiBaseUrl}/api/account/refreshtoken`, {\n          refreshToken: session.refreshToken,\n          userId: session.user,\n          token: session.token\n        }).pipe(map(response => {\n          this.token = response.token;\n          this.tokenExpiration = response.expiration;\n          this.setSession(response);\n          this.userId = response.user;\n          this.newAuthenticationEvent(true);\n          this.refreshPending = false;\n          return response;\n        }), catchError(error => {\n          this.removeSession();\n          this.newAuthenticationEvent(false);\n          this.router.navigate([\"/login\"]);\n          this.refreshPending = false;\n          return throwError(error);\n        }));\n      } else {\n        throw \"Not Logged In\";\n      }\n    } else {\n      return this._authenticated$.pipe(first());\n    }\n  }\n  /**\r\n   * Logs in a user\r\n   * @param login The users credentials\r\n   */\n  login(login) {\n    return this.httpClient.post(`${this.apiBaseUrl}/api/account/createtoken`, login).pipe(map(response => {\n      const tokenInfo = response;\n      this.token = tokenInfo.token;\n      this.tokenExpiration = tokenInfo.expiration;\n      this.setSession(response);\n      this.userId = tokenInfo.user;\n      this.username = login.username;\n      this.newAuthenticationEvent(true);\n      return true;\n    }));\n  }\n  /**\r\n   * Logs out the user, also any other tabs too\r\n   */\n  logout() {\n    this.token = \"\";\n    this.userId = null;\n    this.removeSession();\n    this.newAuthenticationEvent(false);\n    this._logout$.next(true);\n    this.authenticated$ = this._authenticated$.pipe(shareReplay(1));\n  }\n  /**\r\n   * Get Username\r\n   */\n  getUsername() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      if (!_this.username) {\n        if (_this.userId) {\n          yield _this.viewModelDataService.actionViewModel(new Generic(_this.userId), \"account\", \"GetUsername\").toPromise().then(username => {\n            if (username) _this.username = username;\n          });\n        }\n      }\n      return _this.username;\n    })();\n  }\n  /**\r\n   * Handler to set the session\r\n   * @param response\r\n   */\n  setSession(response) {\n    localStorage.setItem('session', JSON.stringify(response));\n  }\n  /**\r\n   * Handler to get the session\r\n   */\n  getSession() {\n    const session = localStorage.getItem('session');\n    if (!session) return null;\n    return JSON.parse(session);\n  }\n  /**\r\n   * Handler to remove the session\r\n   */\n  removeSession() {\n    localStorage.removeItem('session');\n  }\n  /**\r\n   * Handler to get the users token\r\n   */\n  getToken() {\n    const session = this.getSession();\n    if (session) return session.token;else return null;\n  }\n}\nAuthenticationService.ɵfac = function AuthenticationService_Factory(t) {\n  return new (t || AuthenticationService)(i0.ɵɵinject(i1.AppConfigService), i0.ɵɵinject(i2.HttpClient), i0.ɵɵinject(i3.MessageService), i0.ɵɵinject(i4.Router), i0.ɵɵinject(i5.ViewModelDataService));\n};\nAuthenticationService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: AuthenticationService,\n  factory: AuthenticationService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"mappings":"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","names":["JwtHelperService","BehaviorSubject","catchError","first","map","shareReplay","Subject","throwError","Generic","Message","MessageType","IsTrue","AuthenticationService","constructor","appConfigService","httpClient","messageService","router","viewModelDataService","_authenticated$","pipe","_logout$","asObservable","Date","jwtHelper","AppConfig","subscribe","config","apiBaseUrl","WebApi","session","getSession","authenticated","isTokenExpired","token","tokenExpiration","getTokenExpirationDate","userId","user","newAuthenticationEvent","refreshToken","checkAuthenticated","isAuthenticated","logout","navigate","sendMessage","Info","recheckSession","eval","next","refreshPending","post","response","expiration","setSession","error","removeSession","login","tokenInfo","username","authenticated$","getUsername","actionViewModel","toPromise","then","localStorage","setItem","JSON","stringify","getItem","parse","removeItem","getToken","factory","providedIn"],"sourceRoot":"","sources":["C:\\Projects\\web\\ToDoDotNetSix\\ToDoDotNetSixWeb\\ClientApp\\src\\app\\shared\\services\\authentication.service.ts"],"sourcesContent":["/**************************************************************************\r\n*\r\n*  System:    ToDo (Web)\r\n*  Module:    Client App \\ Shared \\ Services\r\n*  Date:      09 AUG 2023\r\n*  Author:    Gary Moran (GM)\r\n*  Function:  Authentication Service\r\n*  Notes:\r\n*\r\n*                   : History of Amendments :\r\n*  Date        Name        Brief description                \r\n*  ----------- ----------  ---------------------------------------------\r\n*  10 AUG 2023 GM          Created\r\n************************************************************************/\r\n\r\n/* eslint-disable @typescript-eslint/no-explicit-any */\r\n\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Injectable } from '@angular/core';\r\nimport { Router } from '@angular/router';\r\nimport { JwtHelperService } from '@auth0/angular-jwt';\r\nimport { BehaviorSubject, catchError, first, map, Observable, shareReplay, Subject, throwError } from 'rxjs';\r\nimport { Generic } from '../models/generic';\r\nimport { Login } from '../models/login';\r\nimport { Message } from '../models/message';\r\nimport { MessageType } from '../models/message-type.enum';\r\nimport { IsTrue } from '../utilities/is-true';\r\nimport { AppConfigService } from './app-config.service';\r\nimport { MessageService } from './message.service';\r\nimport { ViewModelDataService } from './view-model-data.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthenticationService {\r\n\r\n  private _authenticated$ = new Subject<boolean>();\r\n  authenticated$ = this._authenticated$.pipe(shareReplay(1));\r\n\r\n  private _logout$ = new BehaviorSubject<boolean>(false);\r\n  logout$ = this._logout$.asObservable();\r\n\r\n  private apiBaseUrl: string = \"\";\r\n  private token: string = \"\";\r\n  private tokenExpiration: Date | null = new Date();\r\n  private userId: string | null = null;\r\n  private username: string | null = null;\r\n  private jwtHelper: JwtHelperService;\r\n  private authenticated: boolean = false;\r\n  private refreshPending: boolean = false;\r\n\r\n  constructor(\r\n    private appConfigService: AppConfigService,\r\n    private httpClient: HttpClient,\r\n    private messageService: MessageService,\r\n    private router: Router,\r\n    private viewModelDataService: ViewModelDataService\r\n  ) {\r\n\r\n    // authenticate and store token\r\n\r\n    this.jwtHelper = new JwtHelperService();\r\n\r\n    this.appConfigService.AppConfig.subscribe((config) => {\r\n      if (config) {\r\n        this.apiBaseUrl = config?.WebApi ?? \"\";\r\n        const session = this.getSession();\r\n        if (session != null && !this.authenticated) {\r\n          if (!this.jwtHelper.isTokenExpired(session.token)) {\r\n            this.token = session.token;\r\n            this.tokenExpiration = this.jwtHelper.getTokenExpirationDate(session.token);\r\n            this.userId = session.user;\r\n            this.newAuthenticationEvent(true);\r\n          } else {\r\n            this.refreshToken().subscribe(() => { });\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n  * Check if the current session is Authenticated\r\n  */\r\n  checkAuthenticated(): boolean {\r\n\r\n    if (!this.isAuthenticated(true)) {\r\n      this.logout();\r\n      this.router.navigate([\"/login\"]);\r\n      this.messageService.sendMessage(new Message(\"nav-menu\", \"The current session has expired.\", MessageType.Info), true);\r\n      return false;\r\n    } else\r\n      return true;\r\n\r\n  }\r\n\r\n  /**\r\n   * Returns whether the user is authenticated\r\n   */\r\n  isAuthenticated(recheckSession: boolean = false): boolean {\r\n\r\n    if (recheckSession) {\r\n\r\n      // Grab the latest version of the current session before checking the Auth Status\r\n      const session = this.getSession();\r\n      if (session) {\r\n        this.token = session.token;\r\n        this.userId = session.user;\r\n        return IsTrue.eval(this.userId) && IsTrue.eval(this.token) && !this.jwtHelper.isTokenExpired(this.token);\r\n      } else {\r\n        // No session then log out user\r\n        return false;\r\n      }\r\n\r\n    } else {\r\n      return IsTrue.eval(this.userId) && IsTrue.eval(this.token) && !this.jwtHelper.isTokenExpired(this.token) && this.authenticated;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a new authentication event\r\n   * @param authenticated\r\n   */\r\n  newAuthenticationEvent(authenticated: boolean) {\r\n    this.authenticated = authenticated;\r\n    this._authenticated$.next(authenticated);\r\n  }\r\n\r\n  /**\r\n   * Attempts to refresh the users authentication token\r\n   */\r\n  public refreshToken(): Observable<any> {\r\n\r\n    if (!this.refreshPending) {\r\n\r\n      this.refreshPending = true;\r\n      const session = this.getSession();\r\n\r\n      if (session) {\r\n        return this.httpClient.post(`${this.apiBaseUrl}/api/account/refreshtoken`, { refreshToken: session.refreshToken, userId: session.user, token: session.token })\r\n          .pipe(map((response: any) => {\r\n\r\n          this.token = response.token;\r\n          this.tokenExpiration = response.expiration;\r\n          this.setSession(response);\r\n          this.userId = response.user;\r\n          this.newAuthenticationEvent(true);\r\n          this.refreshPending = false;\r\n          return response;\r\n\r\n        }), catchError((error: any) => {\r\n\r\n          this.removeSession();\r\n          this.newAuthenticationEvent(false);\r\n          this.router.navigate([\"/login\"]);\r\n          this.refreshPending = false;\r\n          return throwError(error);\r\n\r\n        }));\r\n      } else {\r\n        throw \"Not Logged In\";\r\n      }\r\n    } else {\r\n      return this._authenticated$.pipe(first());\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Logs in a user\r\n   * @param login The users credentials\r\n   */\r\n  public login(login: Login) {\r\n\r\n    return this.httpClient.post<Login>(`${this.apiBaseUrl}/api/account/createtoken`, login)\r\n      .pipe(\r\n        map((response: any) => {\r\n          const tokenInfo = response;\r\n          this.token = tokenInfo.token;\r\n          this.tokenExpiration = tokenInfo.expiration;\r\n          this.setSession(response);\r\n          this.userId = tokenInfo.user;\r\n          this.username = login.username;\r\n          this.newAuthenticationEvent(true);\r\n          return true;\r\n        }));\r\n  }\r\n\r\n  /**\r\n   * Logs out the user, also any other tabs too\r\n   */\r\n  logout(): void {\r\n    this.token = \"\";\r\n    this.userId = null;\r\n    this.removeSession();\r\n    this.newAuthenticationEvent(false);\r\n    this._logout$.next(true);\r\n    this.authenticated$ = this._authenticated$.pipe(shareReplay(1));\r\n  }\r\n\r\n  /**\r\n   * Get Username\r\n   */\r\n  async getUsername(): Promise<string | null> {\r\n\r\n    if (!this.username) {\r\n\r\n      if (this.userId) {\r\n        await this.viewModelDataService.actionViewModel<Generic, string>(new Generic(this.userId), \"account\", \"GetUsername\").toPromise().then(username => {\r\n          if (username)\r\n              this.username = username;\r\n          });\r\n      }\r\n\r\n    }\r\n\r\n    return this.username;\r\n\r\n  }\r\n\r\n  /**\r\n   * Handler to set the session\r\n   * @param response\r\n   */\r\n  public setSession(response: any): void {\r\n    localStorage.setItem('session', JSON.stringify(response));\r\n  }\r\n\r\n  /**\r\n   * Handler to get the session\r\n   */\r\n  public getSession(): any {\r\n    const session: any = localStorage.getItem('session');\r\n\r\n    if (!session)\r\n      return null;\r\n    return JSON.parse(session);\r\n  }\r\n\r\n  /**\r\n   * Handler to remove the session\r\n   */\r\n  private removeSession(): void {\r\n    localStorage.removeItem('session');\r\n  }\r\n\r\n  /**\r\n   * Handler to get the users token\r\n   */\r\n  public getToken(): any {\r\n    const session = this.getSession();\r\n    if (session)\r\n      return session.token;\r\n    else\r\n      return null;\r\n  }\r\n\r\n}\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}